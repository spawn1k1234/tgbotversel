// index.js
const { Telegraf, Markup, Scenes, session } = require("telegraf");
const { connectDB, getDB } = require("./db");
require("dotenv").config();

const bot = new Telegraf(process.env.BOT_TOKEN);

// Ð¡Ñ†ÐµÐ½Ð° Ð´Ð»Ñ Ñ€Ð°ÑÑÑ‹Ð»ÐºÐ¸
const broadcastScene = new Scenes.WizardScene(
  "broadcast",
  async (ctx) => {
    if (ctx.from.id.toString() !== process.env.ADMIN_ID) {
      await ctx.reply("â›”ï¸ Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº ÑÑ‚Ð¾Ð¹ ÐºÐ¾Ð¼Ð°Ð½Ð´Ðµ.");
      return ctx.scene.leave();
    }
    await ctx.reply("ðŸ“· ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ñ„Ð¾Ñ‚Ð¾ Ð´Ð»Ñ Ñ€Ð°ÑÑÑ‹Ð»ÐºÐ¸:");
    return ctx.wizard.next();
  },
  async (ctx) => {
    if (!ctx.message.photo) {
      await ctx.reply("âš ï¸ ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ.");
      return;
    }
    ctx.wizard.state.photo =
      ctx.message.photo[ctx.message.photo.length - 1].file_id;
    await ctx.reply("âœï¸ Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ñ‚ÐµÐºÑÑ‚ Ð´Ð»Ñ Ñ€Ð°ÑÑÑ‹Ð»ÐºÐ¸:");
    return ctx.wizard.next();
  },
  async (ctx) => {
    if (!ctx.message.text) {
      await ctx.reply("âš ï¸ ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ñ‚ÐµÐºÑÑ‚.");
      return;
    }
    ctx.wizard.state.caption = ctx.message.text;
    await ctx.replyWithPhoto(ctx.wizard.state.photo, {
      caption: ctx.wizard.state.caption,
    });
    await ctx.reply("âœ… ÐŸÑ€ÐµÐ´Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð³Ð¾Ñ‚Ð¾Ð². ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ñ€Ð°ÑÑÑ‹Ð»ÐºÑƒ? (Ð´Ð°/Ð½ÐµÑ‚)");
    return ctx.wizard.next();
  },
  async (ctx) => {
    const confirmation = ctx.message.text.toLowerCase();
    if (confirmation === "Ð´Ð°") {
      const db = getDB();
      const users = await db.collection("users").find().toArray();
      for (const user of users) {
        try {
          await ctx.telegram.sendPhoto(user.chatId, ctx.wizard.state.photo, {
            caption: ctx.wizard.state.caption,
          });
        } catch (error) {
          console.error(
            `âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ ${user.chatId}:`,
            error
          );
        }
      }
      await ctx.reply("ðŸ“¢ Ð Ð°ÑÑÑ‹Ð»ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°.");
    } else {
      await ctx.reply("âŒ Ð Ð°ÑÑÑ‹Ð»ÐºÐ° Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð°.");
    }
    return ctx.scene.leave();
  }
);

const stage = new Scenes.Stage([broadcastScene]);
bot.use(session());
bot.use(stage.middleware());

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start
bot.start(async (ctx) => {
  const db = getDB();
  const user = {
    chatId: ctx.chat.id,
    username: ctx.from.username,
    first_name: ctx.from.first_name,
  };

  await db
    .collection("users")
    .updateOne({ chatId: user.chatId }, { $set: user }, { upsert: true });

  await ctx.reply(
    `ÐŸÑ€Ð¸Ð²ÐµÑ‚, ${ctx.from.first_name || "Ð´Ñ€ÑƒÐ³"}! ðŸ‘‹`,
    Markup.inlineKeyboard([
      [Markup.button.url("ðŸ’¬ ÐœÐµÐ½ÐµÐ´Ð¶ÐµÑ€", "https://t.me/manager_username")],
      [
        Markup.button.url(
          "ðŸ“¸ Instagram",
          "https://instagram.com/your_instagram"
        ),
      ],
    ])
  );
});

// ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ñ€Ð°ÑÑÑ‹Ð»ÐºÐ¸
bot.command("broadcast", (ctx) => ctx.scene.enter("broadcast"));

// Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°
(async () => {
  await connectDB();
  bot.launch();
  console.log("ðŸ¤– Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½");
})();
